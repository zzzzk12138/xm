# BMS系统单元测试文档

## 1. BMS核心模块测试

### 1.1 电池类型服务测试 (batServiceTest)

#### 测试环境设置
```java
@Mock
private batMapper batMapper;

@InjectMocks
private batServiceImpl batService;

@BeforeEach
void setUp() {
    MockitoAnnotations.openMocks(this);
    testBatteryType = new BatteryType();
    testBatteryType.setId(1);
    testBatteryType.setTypeName("三元电池");
    testBatteryType.setDeleted(false);
}
```

#### 测试用例列表

1. **创建电池类型测试**
   - 对应接口：POST /api/battery-type
   - 测试方法：`createBatteryType_Success`
   - 测试目的：验证成功创建新电池类型的功能
   - 输入数据：
     ```json
     {
         "typeName": "三元电池"
     }
     ```
   - 预期输出：
     ```json
     {
         "id": 1,
         "typeName": "三元电池",
         "deleted": false
     }
     ```
   - 测试步骤：
     1. 准备新电池类型数据
     2. 模拟mapper插入行为
     3. 执行创建操作
     4. 验证返回结果
   - 验证点：
     - 返回对象不为空
     - ID正确设置
     - 类型名称正确
     - 删除标志为false

2. **根据ID查询电池类型测试**
   - 对应接口：GET /api/battery-type/{id}
   - 测试方法：`getBatteryTypeById_Success`
   - 测试目的：验证成功查询已存在电池类型的功能
   - 输入数据：
     - ID: 1
   - 预期输出：
     ```json
     {
         "id": 1,
         "typeName": "三元电池",
         "deleted": false
     }
     ```
   - 测试步骤：
     1. 模拟mapper查询行为
     2. 执行查询操作
     3. 验证返回结果
   - 验证点：
     - 返回对象不为空
     - ID匹配
     - 类型名称正确
     - 删除标志正确

3. **查询不存在的电池类型测试**
   - 对应接口：GET /api/battery-type/{id}
   - 测试方法：`getBatteryTypeById_NotFound`
   - 测试目的：验证查询不存在电池类型时的异常处理
   - 输入数据：
     - ID: 999（不存在的ID）
   - 预期输出：
     - 异常：RuntimeException
     - 消息："未找到ID为: 999 的电池类型"
   - 测试步骤：
     1. 模拟mapper返回空结果
     2. 执行查询操作
     3. 验证异常抛出

4. **查询已删除电池类型测试**
   - 对应接口：GET /api/battery-type/{id}
   - 测试方法：`getBatteryTypeById_Deleted`
   - 测试目的：验证查询已删除电池类型时的异常处理
   - 输入数据：
     ```json
     {
         "id": 1,
         "typeName": "三元电池",
         "deleted": true
     }
     ```
   - 预期输出：
     - 异常：RuntimeException
     - 消息："未找到ID为: 1 的电池类型"
   - 测试步骤：
     1. 准备已删除的测试数据
     2. 执行查询操作
     3. 验证异常抛出

5. **获取所有电池类型测试**
   - 对应接口：GET /api/battery-type
   - 测试方法：`getAllBatteryTypes_Success`
   - 测试目的：验证获取所有电池类型列表的功能
   - 输入数据：无
   - 预期输出：
     ```json
     [
         {
             "id": 1,
             "typeName": "三元电池",
             "deleted": false
         },
         {
             "id": 2,
             "typeName": "铁锂电池",
             "deleted": false
         }
     ]
     ```
   - 测试步骤：
     1. 准备测试数据列表
     2. 模拟mapper查询行为
     3. 执行查询操作
     4. 验证返回结果

## 2. Signal模块测试

### 2.1 信号服务测试 (signalServiceTest)

#### 测试环境设置
```java
@Mock
private signalMapper signalMapper;
@Mock
private RedisTemplate<String, Object> redisTemplate;
@Mock
private ValueOperations<String, Object> valueOperations;
@Mock
private Lock lock;
@InjectMocks
private signalServiceImpl signalService;
```

#### 测试用例列表

1. **创建信号记录测试**
   - 对应接口：POST /api/signal
   - 测试方法：`createSignal_Success`
   - 测试目的：验证成功创建新信号记录的功能
   - 输入数据：
     ```json
     {
         "vid": "TEST_VID_001",
         "maxVoltage": 4.2,
         "minVoltage": 3.0,
         "maxCurrent": 10.0,
         "minCurrent": -10.0
     }
     ```
   - 预期输出：
     ```json
     {
         "signalId": 1,
         "vid": "TEST_VID_001",
         "maxVoltage": 4.2,
         "minVoltage": 3.0,
         "maxCurrent": 10.0,
         "minCurrent": -10.0,
         "recordedAt": "2024-01-01T12:00:00",
         "status": 0
     }
     ```
   - 测试步骤：
     1. 准备新信号数据
     2. 模拟mapper和Redis操作
     3. 执行创建操作
     4. 验证返回结果

2. **创建空信号记录测试**
   - 对应接口：POST /api/signal
   - 测试方法：`createSignal_NullSignal`
   - 测试目的：验证创建空信号时的异常处理
   - 输入数据：null
   - 预期输出：
     - 异常：IllegalArgumentException
     - 消息："信号数据不能为空"
   - 测试步骤：
     1. 传入null作为参数
     2. 验证异常抛出

3. **从缓存获取信号记录测试**
   - 对应接口：GET /api/signal/{signalId}
   - 测试方法：`getSignalById_FromCache`
   - 测试目的：验证从Redis缓存获取信号记录的功能
   - 输入数据：
     - signalId: 1
   - 预期输出：
     ```json
     {
         "signalId": 1,
         "vid": "TEST_VID_001",
         "maxVoltage": 4.2,
         "minVoltage": 3.0,
         "maxCurrent": 10.0,
         "minCurrent": -10.0,
         "recordedAt": "2024-01-01T12:00:00",
         "status": 0
     }
     ```
   - 测试步骤：
     1. 模拟Redis缓存中有数据
     2. 执行查询操作
     3. 验证返回结果

4. **从缓存获取车辆信号列表测试**
   - 对应接口：GET /api/signal/vehicle/{vid}
   - 测试方法：`getSignalsByVid_FromCache`
   - 测试目的：验证从Redis缓存获取车辆信号列表的功能
   - 输入数据：
     - vid: "TEST_VID_001"
   - 预期输出：
     ```json
     [
         {
             "signalId": 1,
             "vid": "TEST_VID_001",
             "maxVoltage": 4.2,
             "minVoltage": 3.0,
             "maxCurrent": 10.0,
             "minCurrent": -10.0,
             "recordedAt": "2024-01-01T12:00:00",
             "status": 0
         }
     ]
     ```
   - 测试步骤：
     1. 准备测试数据列表
     2. 模拟Redis缓存中有数据
     3. 执行查询操作
     4. 验证返回结果

## 3. Warn模块测试

### 3.1 警告服务测试 (warnServiceTest)

#### 测试环境设置
```java
@Mock
private warnMapper warnMapper;
@Mock
private vehicleService vehicleService;
@Mock
private ObjectMapper objectMapper;
@Mock
private vehicleMapper vehicleMapper;
@Mock
private VoltageProcessor voltageProcessor;
@Mock
private CurrentProcessor currentProcessor;
@InjectMocks
private warnServiceImpl warnService;
```

#### 测试用例列表

1. **处理空警告列表测试**
   - 对应接口：POST /api/warn
   - 测试方法：`processWarns_EmptyList`
   - 测试目的：验证处理空警告列表的功能
   - 输入数据：空列表 []
   - 预期输出：空列表 []
   - 测试步骤：
     1. 传入空列表
     2. 执行处理操作
     3. 验证返回结果

2. **处理null警告列表测试**
   - 对应接口：POST /api/warn
   - 测试方法：`processWarns_NullList`
   - 测试目的：验证处理null警告列表时的异常处理
   - 输入数据：null
   - 预期输出：
     - 异常：IllegalArgumentException
     - 消息："警告信息列表不能为null"
   - 测试步骤：
     1. 传入null作为参数
     2. 验证异常抛出

3. **获取车辆警告记录测试**
   - 对应接口：GET /api/warn/vehicle/{carId}
   - 测试方法：`getWarnsByCarId_Success`
   - 测试目的：验证获取车辆警告记录的功能
   - 输入数据：
     - carId: 100
   - 预期输出：
     ```json
     [
         {
             "车架编号": 100,
             "电池类型": "锂电池",
             "预警名称": "电压异常",
             "预警等级": 1,
             "预警时间": "2024-01-01T12:00:00"
         }
     ]
     ```
   - 测试步骤：
     1. 准备测试数据
     2. 模拟mapper查询行为
     3. 执行查询操作
     4. 验证返回结果

4. **获取不存在车辆的警告记录测试**
   - 对应接口：GET /api/warn/vehicle/{carId}
   - 测试方法：`getWarnsByCarId_VehicleNotFound`
   - 测试目的：验证获取不存在车辆的警告记录时的处理
   - 输入数据：
     - carId: 999（不存在的ID）
   - 预期输出：
     ```json
     [
         {
             "车架编号": 999,
             "error": "未找到车辆信息"
         }
     ]
     ```
   - 测试步骤：
     1. 模拟车辆不存在的情况
     2. 执行查询操作
     3. 验证返回结果

5. **获取无效车辆ID的警告记录测试**
   - 对应接口：GET /api/warn/vehicle/{carId}
   - 测试方法：`getWarnsByCarId_InvalidId`
   - 测试目的：验证使用无效车辆ID查询警告记录时的处理
   - 输入数据：
     - carId: null
   - 预期输出：
     ```json
     [
         {
             "车架编号": null,
             "error": "未找到车辆信息"
         }
     ]
     ```
   - 测试步骤：
     1. 传入null作为车辆ID
     2. 执行查询操作
     3. 验证返回结果
